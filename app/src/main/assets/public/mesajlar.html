<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mesajlar ‚Ä¢ √úreten Eller</title>
  <link rel="icon" href="./assets/icons/favicon.png" />
  <style>
    :root{
      --bg1:#0b1220; --bg2:#0a0f1c; --ink:#e5e7eb; --muted:#9ca3af; --accent:#22d3ee;
      --ok:#10b981; --warn:#f59e0b; --err:#ef4444; --brd:#1f2937; --card:#0e172a; --card2:#0b1326;
    }
    *{box-sizing:border-box}
    html,body{
      margin:0;padding:0;
      background:linear-gradient(180deg,var(--bg1),var(--bg2));
      color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
      max-width:100%;
      overflow:hidden;
    }

    /* mobil klavye i√ßin 100dvh */
    .page{
      height:100dvh;
      display:grid;
      grid-template-columns:320px 1fr;
      gap:10px;
      padding:10px;
    }
    @media(max-width:900px){ .page{ grid-template-columns:1fr } }

    .panel{border:1px solid var(--brd);border-radius:14px;background:linear-gradient(145deg,var(--card),var(--card2));overflow:hidden;position:relative}
    .left{display:flex;flex-direction:column}
    .topbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:8px;padding:10px;border-bottom:1px solid var(--brd);background:linear-gradient(145deg,var(--card),var(--card2))}
    .logo{display:flex;align-items:center;gap:.5rem;font-weight:900}
    .logo img{width:24px;height:24px}
    .spacer{flex:1}
    .btn{display:inline-flex;align-items:center;gap:.45rem;padding:.5rem .8rem;border:1px solid var(--brd);border-radius:10px;background:#0b1220;color:var(--ink);font-weight:800;cursor:pointer;white-space:nowrap}
    .btn.ghost{background:transparent}
    .btn.accent{background:linear-gradient(180deg,#22d3ee,#0ea5b3);color:#042026;border-color:#0ea5b3}
    .btn.primary{background:linear-gradient(180deg,#10b981,#128473);border-color:#0e766e}
    .btn.danger{background:linear-gradient(180deg,#ef4444,#7a1b1b);border-color:#7a1b1b;color:#fff}

    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .search{padding:8px 10px;border-bottom:1px solid var(--brd)}
    .search input{width:100%;border:1px solid var(--brd);border-radius:10px;background:#0b1326;color:var(--ink);padding:10px}

    #threads{overflow:auto;flex:1}
    .empty{padding:12px;color:var(--muted);text-align:center}
    .th{display:grid;grid-template-columns:44px 1fr auto;gap:8px;padding:10px;border-bottom:1px solid var(--brd);cursor:pointer}
    .th:hover{background:rgba(255,255,255,.03)}
    .ava{width:44px;height:44px;border-radius:10px;border:1px solid var(--brd);background:#111827 center/cover no-repeat}
    .thTitle{font-weight:800}
    .thSub{color:var(--muted);font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:220px}
    .thTime{color:var(--muted);font-size:.8rem;min-width:80px;text-align:right}

    /* Saƒü: chat */
    .right{display:grid;grid-template-rows:auto 1fr auto; min-height:0;}
    .chatTop{display:flex;align-items:center;gap:10px;padding:10px;border-bottom:1px solid var(--brd);background:linear-gradient(145deg,var(--card),var(--card2))}
    .chatTop .name{font-weight:900;cursor:pointer}
    .chatTop .mini{color:var(--muted);font-size:.9rem}

    .chatBody{
      overflow:auto;
      padding:12px;
      display:flex;flex-direction:column;gap:8px;
      min-height:0; /* sticky footer i√ßin */
    }
    .msg{max-width:80%;padding:10px 12px;border:1px solid var(--brd);border-radius:12px;background:#0b1326;white-space:pre-wrap;word-wrap:break-word}
    .me{align-self:flex-end;background:#0e2233}
    .other{align-self:flex-start}

    /* Alt bar her zaman g√∂r√ºns√ºn */
    .chatInput{
      display:flex;gap:8px;padding:10px;border-top:1px solid var(--brd);
      position:sticky;bottom:0;z-index:5;
      background:linear-gradient(145deg,var(--card),var(--card2));
      padding-bottom: calc(10px + env(safe-area-inset-bottom,0px));
    }
    .chatInput input{
      flex:1;border:1px solid var(--brd);border-radius:999px;background:#0b1326;color:#0000; /* color later overridden by JS fix */
      padding:12px 14px;font-size:16px; /* iOS zoom‚Äôu √∂nlemek i√ßin >=16px */
    }
    .chatInput button{
      border:1px solid var(--brd);border-radius:999px;background:var(--accent);color:#03222a;
      font-weight:900;padding:12px 16px;cursor:pointer;min-width:88px;
    }

    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.25rem .6rem;border:1px solid var(--brd);border-radius:999px}
    .pill.badge{background:#0b1326}

    /* Saƒü altta yedek FAB g√∂nder (mobilde asla kaybolmasƒ±n) */
    .fab-send{
      position:fixed;right:14px;bottom:calc(14px + env(safe-area-inset-bottom,0px));
      width:56px;height:56px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      border:1px solid var(--brd);background:var(--accent);color:#03222a;font-weight:900;
      box-shadow:0 8px 24px rgba(0,0,0,.35);cursor:pointer;z-index:20;
    }
    @media(min-width:901px){ .fab-send{ display:none; } } /* sadece mobil/tablet */
  </style>

  <script type="module" src="/firebase-init.js"></script>
</head>
<body>
  <div class="page">
    <!-- LEFT -->
    <div class="panel left">
      <div class="topbar">
        <div class="logo">
          <img src="./√ºreteneller.png" alt="logo" />
          <span>√úreten Eller</span>
        </div>
        <div class="spacer"></div>
        <div class="actions">
          <button class="btn ghost"   id="btnHome"  type="button">üè† Ana sayfa</button>
          <button class="btn accent"  id="btnNotif" type="button">üîî <span id="notifLbl">Bildirimleri A√ß</span></button>
          <button class="btn primary" id="btnSound" type="button">üîä <span id="soundLbl">Sesi A√ß</span></button>
        </div>
      </div>

      <div class="search">
        <input id="search" placeholder="Ki≈üi veya mesaj ara" />
      </div>

      <div id="threads">
        <div class="empty">Konu≈üma yok.</div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="panel right">
      <div class="chatTop">
        <div id="peerAva" class="ava"></div>
        <div style="flex:1">
          <div class="name" id="peerName" title="Profili a√ß">Ki≈üi se√ßin</div>
          <div class="mini" id="peerInfo">‚Äî</div>
        </div>
        <div class="pill badge" id="unreadBadge" title="Okunmamƒ±≈ü mesaj">0</div>
        <button class="btn" id="btnHideThread" title="Bu konu≈ümayƒ± panelimden kaldƒ±r">üëÅ‚Äçüó® Panelimden kaldƒ±r</button>
      </div>

      <div id="chat" class="chatBody" aria-live="polite">
        <div class="empty">Soldan bir konu≈üma se√ßin.</div>
      </div>

      <div class="chatInput">
        <input id="msgInput" placeholder="Mesaj yazƒ±n‚Ä¶" />
        <button id="btnSend">G√∂nder</button>
      </div>
    </div>
  </div>

  <!-- mobil g√ºvenlik: yedek g√∂nder -->
  <button class="fab-send" id="fabSend" aria-label="G√∂nder">‚û§</button>

  <audio id="ding" preload="auto" src="./notify.wav"></audio>

  <script>
  const log = (...a)=>console.log('[msg]',...a);
  const $ = s=>document.querySelector(s);
  const qs = k=> new URLSearchParams(location.search).get(k)||'';

  let __me=null, __threadsUnsub=null, __msgsUnsub=null;
  let __curThreadId=null, __curPeerUid=null;
  let __ding=null, __soundEnabled = (localStorage.getItem('ue_sound_enabled')==='1');
  let __soundUnlocked=false;
  let __hiddenThreads=new Set();
  let __lastSeenMap={};

  // === FCM CONFIG ===
  const FCM_VAPID_KEY = 'WEB_PUSH_CERTIFICATE_PUBLIC_VAPID_KEY'; // Firebase Console > Cloud Messaging > Web Push
  const FCM_SW_PATH = '/firebase-messaging-sw.js'; // Bu dosyayƒ± site k√∂k√ºne (ve docs/ k√∂k√ºne) koymalƒ±sƒ±n

  const LS_KEY_THREADS = uid => `ue.hiddenThreads.${uid}`;
  const getHiddenThreads = uid => { try{return new Set(JSON.parse(localStorage.getItem(LS_KEY_THREADS(uid))||'[]'));}catch{return new Set()} };
  const setHiddenThreads = (uid,set)=>{ try{localStorage.setItem(LS_KEY_THREADS(uid), JSON.stringify([...set]));}catch{} };

  async function api(){ return await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js'); }

  const _briefCache=new Map();
  async function getUserBrief(uid){
    if(!uid) return {name:'Kullanƒ±cƒ±',avatar:'/assets/img/avatar-default.png'};
    if(_briefCache.has(uid)) return _briefCache.get(uid);
    try{
      const {doc,getDoc}=await api();
      const snap=await getDoc(doc(self.db,'users',uid));
      const d=snap.exists()?(snap.data()||{}):{};
      const name=[d.name||d.firstName||'',d.surname||d.lastName||''].filter(Boolean).join(' ')||d.displayName||'Kullanƒ±cƒ±';
      const brief={name,avatar:d.avatar||d.photoURL||'/assets/img/avatar-default.png'};
      _briefCache.set(uid,brief); return brief;
    }catch{ return {name:'Kullanƒ±cƒ±',avatar:'/assets/img/avatar-default.png'} }
  }

  function updateNotifLabel(){
    if(!('Notification' in window)){ $('#notifLbl').textContent='Tarayƒ±cƒ± desteklemiyor'; return; }
    $('#notifLbl').textContent = Notification.permission==='granted' ? 'Bildirimler aktif'
      : (Notification.permission==='denied' ? 'Bildirim engelli' : 'Bildirimleri A√ß');
  }
  function updateSoundLabel(){ $('#soundLbl').textContent = __soundEnabled ? 'Sesi Kapat' : 'Sesi A√ß'; }

  function bindButtons(){
    $('#btnHome').addEventListener('click', e=>{ e.preventDefault(); location.href='/home.html'; });
    $('#btnNotif').addEventListener('click', onNotifClick);
    $('#btnSound').addEventListener('click', onSoundClick);
    $('#btnHideThread').addEventListener('click', hideCurrentThreadForMe);
    $('#peerName').addEventListener('click', ()=>{ if(__curPeerUid) location.href=`/docs/profile.html?uid=${encodeURIComponent(__curPeerUid)}`; });
    $('#msgInput').addEventListener('keydown', e=>{ if(e.key==='Enter') sendMessage(); });
    $('#btnSend').addEventListener('click', sendMessage);
    $('#fabSend').addEventListener('click', sendMessage);
    $('#search').addEventListener('input', ()=> listenThreads());

    // ses kilidi
    ['click','pointerdown','touchstart','keydown'].forEach(ev=>{
      window.addEventListener(ev, ()=>{ if(__soundEnabled) tryUnlockSound(false); }, {capture:true});
    });

    // mobil klavye / viewport y√ºkseklik
    if (window.visualViewport){
      const chat = $('#chat');
      const handler = ()=>{
        const vv = window.visualViewport;
        const bottomInset = Math.max(0, (window.innerHeight - vv.height - vv.offsetTop));
        chat.style.paddingBottom = (bottomInset + 90) + 'px'; // alt bar + klavye
      };
      window.visualViewport.addEventListener('resize', handler);
      window.visualViewport.addEventListener('scroll', handler);
    }
  }

  // ==== WEB PUSH / FCM entegrasyonu ====
  async function setupFCMForThisDevice(currentUid){
    try{
      if(!('Notification' in window)) return null;
      if(location.protocol!=='https:' && location.hostname!=='localhost'){
        alert('Bildirimler i√ßin HTTPS gerekir (localhost hari√ß).');
        return null;
      }
      // messaging mod√ºllerini y√ºkle
      const { getMessaging, getToken, onMessage, isSupported } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-messaging.js');
      if(!(await isSupported())){ updateNotifLabel(); return null; }

      // SW kaydƒ±
      const reg = await navigator.serviceWorker.register(FCM_SW_PATH, { scope: '/' });

      // izin iste
      const perm = await Notification.requestPermission();
      updateNotifLabel();
      if(perm!=='granted') return null;

      // token al
      const messaging = getMessaging(self.app);
      const token = await getToken(messaging, { vapidKey: FCM_VAPID_KEY, serviceWorkerRegistration: reg });
      if(!token) return null;

      // Token'ƒ± Firestore'a yaz
      const { getFirestore, doc, setDoc, serverTimestamp, updateDoc, arrayUnion } = await api();
      const db = getFirestore(self.app);
      try{
        await setDoc(doc(db,'fcmTokens', token), {
          token, uid: currentUid||null, platform:'web', active:true, createdAt: serverTimestamp()
        }, { merge: true });
      }catch(e){ console.warn('fcmTokens write err', e); }
      if(currentUid){
        try{ await updateDoc(doc(db,'users', currentUid), { fcmTokens: arrayUnion(token) }); }catch{}
      }

      // Uygulama a√ßƒ±kken gelen push -> bildirim + ding
      onMessage(messaging, (payload)=>{
        try{ new Notification(payload?.notification?.title||'Yeni mesaj', {
          body: payload?.notification?.body||'', icon:'./assets/icons/favicon.png'
        }); }catch{}
        playDing();
      });

      return token;
    }catch(e){ console.warn('[msg] setupFCM error', e); return null; }
  }

  function onNotifClick(){
    if(!('Notification' in window)){ alert('Tarayƒ±cƒ±nƒ±z bildirimleri desteklemiyor.'); return; }
    // izin + FCM kaydƒ±
    setupFCMForThisDevice(__me?.uid||null).then(tok=>{
      if(tok){
        try{ new Notification('Bildirim a√ßƒ±k', { body:'Bu cihaz i√ßin bildirimler etkin.', icon:'./√ºreteneller.png' }); }catch{}
      }
    });
  }

  function onSoundClick(){
    __soundEnabled = !__soundEnabled;
    localStorage.setItem('ue_sound_enabled', __soundEnabled?'1':'0');
    updateSoundLabel();
    if(__soundEnabled) tryUnlockSound(true);
  }
  function tryUnlockSound(playTest){
    if(!__ding) return;
    if(__soundUnlocked){ if(playTest && __soundEnabled) playDing(); return; }
    __ding.muted=false; __ding.currentTime=0;
    __ding.play().then(()=>{ __soundUnlocked=true; if(playTest && __soundEnabled) playDing(); }).catch(()=>{});
  }
  function playDing(){
    if(!__soundEnabled || !__ding) return;
    __ding.currentTime=0; __ding.play().catch(()=>{});
    if('vibrate' in navigator){ try{ navigator.vibrate([60,30,60]); }catch{} }
  }

  function fmtDate(ts){ try{ const d=ts?.toDate?ts.toDate():(ts?new Date(ts):null); return d? d.toLocaleString('tr-TR'):'';}catch{ return '' } }
  function escapeHtml(x){ return (x||'').replace(/[<>&]/g,s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s])); }

  function renderThreadsSnapshotLike(snap){
    const listEl=$('#threads'); const rows=[];
    snap.forEach(ds=>{
      const d=ds.data()||{}; if(__hiddenThreads.has(ds.id)) return;
      const arr=d.participants||[]; const otherUid=arr.find(x=>x!==__me.uid)||'';
      rows.push({id:ds.id,d,otherUid});
    });
    rows.sort((a,b)=>{
      const ta=a.d.lastAt?.toMillis? a.d.lastAt.toMillis() : (a.d.lastAt? new Date(a.d.lastAt).getTime():0);
      const tb=b.d.lastAt?.toMillis? b.d.lastAt.toMillis() : (b.d.lastAt? new Date(b.d.lastAt).getTime():0);
      return (tb||0)-(ta||0);
    });
    const qtxt = ($('#search')?.value||'').trim().toLowerCase();
    listEl.innerHTML = rows.length ? '' : '<div class="empty">Konu≈üma yok.</div>';
    let unread=0;

    (async()=>{
      for(const r of rows){
        const other = await getUserBrief(r.otherUid);
        if(qtxt && !(other.name||'').toLowerCase().includes(qtxt) && !(r.d.lastText||'').toLowerCase().includes(qtxt)) continue;

        const lastMillis = r.d.lastAt?.toMillis ? r.d.lastAt.toMillis() : (r.d.lastAt? new Date(r.d.lastAt).getTime():0);
        const seenMy = r.d.seen && r.d.seen[__me.uid] ? (r.d.seen[__me.uid].toMillis ? r.d.seen[__me.uid].toMillis() : new Date(r.d.seen[__me.uid]).getTime() ) : 0;
        const isUnread = (r.d.lastFrom && r.d.lastFrom !== __me.uid && lastMillis > (seenMy||0));
        if(isUnread) unread++;

        const t=document.createElement('div');
        t.className='th'; t.dataset.id=r.id;
        t.innerHTML=`
          <div class="ava" style="background-image:url('${other.avatar||'/assets/img/avatar-default.png'}')"></div>
          <div>
            <div class="thTitle">${escapeHtml(other.name||'Kullanƒ±cƒ±')}</div>
            <div class="thSub">${escapeHtml(r.d.lastText||'')}</div>
          </div>
          <div class="thTime">${r.d.lastAt? fmtDate(r.d.lastAt):''}</div>`;
        t.addEventListener('click', ()=> openThread(r.id, r.otherUid, other));
        listEl.appendChild(t);

        const prev = __lastSeenMap[r.id] || 0;
        if(lastMillis && lastMillis>prev && r.d.lastText && r.d.lastFrom && r.d.lastFrom!==__me.uid){
          playDing();
          if(document.hidden && 'Notification' in window && Notification.permission==='granted'){
            try{ new Notification(other.name||'Yeni mesaj',{ body:r.d.lastText, icon:'./√ºreteneller.png' }); }catch{}
          }
        }
        __lastSeenMap[r.id]=lastMillis||prev;
      }
      $('#unreadBadge').textContent=String(unread);
    })();
  }

  async function listenThreads(){
    if(__threadsUnsub){ try{__threadsUnsub();}catch{} __threadsUnsub=null; }
    const {collection,query,where,onSnapshot,getDocs}=await api();
    const baseQ=query(collection(self.db,'messages'), where('participants','array-contains', __me.uid));
    $('#threads').innerHTML='<div class="empty">Y√ºkleniyor‚Ä¶</div>';
    try{
      __threadsUnsub = onSnapshot(baseQ, snap=>renderThreadsSnapshotLike(snap), async err=>{
        console.warn('[msg] threads snapshot err:',err);
        const snap2=await getDocs(baseQ); renderThreadsSnapshotLike(snap2);
      });
    }catch(err){
      const snap2=await getDocs(baseQ); renderThreadsSnapshotLike(snap2);
    }
  }

  async function listenMessages(threadId){
    if(__msgsUnsub){ try{__msgsUnsub();}catch{} __msgsUnsub=null; }
    const {collection,query,orderBy,onSnapshot}=await api();
    const q=query(collection(self.db,'messages',threadId,'items'), orderBy('createdAt','asc'));
    const chat=$('#chat'); chat.innerHTML='';
    __msgsUnsub = onSnapshot(q, snap=>{
      chat.innerHTML=''; snap.forEach(ds=>{
        const m=ds.data()||{}; const div=document.createElement('div');
        div.className='msg '+(m.from===__me.uid?'me':'other'); div.textContent=m.text||''; chat.appendChild(div);
      });
      chat.scrollTop=chat.scrollHeight;
    }, err=>console.warn('[msg] listenMessages err',err));
  }

  async function openThread(threadId, peerUid, brief=null){
    __curThreadId=threadId; __curPeerUid=peerUid;
    const info = brief || await getUserBrief(peerUid);
    $('#peerAva').style.backgroundImage=`url('${info.avatar||'/assets/img/avatar-default.png'}')`;
    $('#peerName').textContent=info.name||'Kullanƒ±cƒ±';
    $('#peerInfo').textContent=peerUid;
    $('#peerName').onclick=()=>{ location.href=`/docs/profile.html?uid=${encodeURIComponent(peerUid)}`; };
    try{
      const {doc,updateDoc,serverTimestamp}=await api();
      await updateDoc(doc(self.db,'messages',threadId), { [`seen.${__me.uid}`]: serverTimestamp() });
    }catch{}
    await listenMessages(threadId);
    // odakla
    $('#msgInput').focus({preventScroll:true});
  }

  async function createOrGetThread(peerUid, otherName='', otherAvatar=''){
    const {collection,query,where,getDocs,doc,setDoc,serverTimestamp}=await api();
    const q=query(collection(self.db,'messages'), where('participants','array-contains', __me.uid));
    const snap=await getDocs(q); let found='';
    snap.forEach(ds=>{ const arr=(ds.data()?.participants)||[]; if(arr.includes(peerUid)) found=ds.id; });
    if(found) return found;
    const participants=[__me.uid,peerUid];
    const ref=doc(self.db,'messages', crypto.randomUUID? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2,8)));
    await setDoc(ref,{ participants, lastText:'', lastAt:serverTimestamp(), otherName:otherName||'', otherAvatar:otherAvatar||'' });
    return ref.id;
  }

  async function sendMessage(){
    const text=($('#msgInput').value||'').trim();
    if(!text || !__curThreadId) return;
    $('#msgInput').value='';
    try{
      const {collection,addDoc,serverTimestamp,doc,updateDoc}=await api();
      await addDoc(collection(self.db,'messages',__curThreadId,'items'),{ text, from:__me.uid, createdAt:serverTimestamp() });
      await updateDoc(doc(self.db,'messages',__curThreadId),{ lastText:text, lastAt:serverTimestamp(), lastFrom:__me.uid });
    }catch(e){ console.warn('[msg] sendMessage err',e); }
    // mobilde yazdƒ±ktan sonra G√∂nder g√∂r√ºn√ºr kalsƒ±n
    setTimeout(()=>{ $('#msgInput').blur(); }, 10);
  }

  function hideCurrentThreadForMe(){
    if(!__curThreadId || !__me) return;
    __hiddenThreads.add(__curThreadId);
    setHiddenThreads(__me.uid,__hiddenThreads);
    __curThreadId=null; __curPeerUid=null;
    $('#peerAva').style.backgroundImage=''; $('#peerName').textContent='Ki≈üi se√ßin'; $('#peerInfo').textContent='‚Äî';
    $('#chat').innerHTML='<div class="empty">Soldan bir konu≈üma se√ßin.</div>';
    listenThreads();
  }

  function boot(){
    __ding=$('#ding'); bindButtons(); updateNotifLabel(); updateSoundLabel();
    // iOS renk kontrast hatasƒ± ya≈üayan tarayƒ±cƒ±lar i√ßin fix
    try{ document.querySelector('.chatInput input').style.color = getComputedStyle(document.body).getPropertyValue('--ink'); }catch{}

    self.onAuthStateChanged(self.auth, async (u)=>{
      __me=u||null; if(!__me){ location.href='/login.html'; return; }
      __hiddenThreads=getHiddenThreads(__me.uid);
      const urlPeer=qs('peer');
      if(urlPeer){
        const name=qs('name')?decodeURIComponent(qs('name')):''; const ava=qs('ava')||'';
        try{ const tid=await createOrGetThread(urlPeer,name,ava); openThread(tid,urlPeer); }catch{}
        history.replaceState({},document.title,location.pathname);
      }
      // oturum a√ßƒ±nca bu cihazƒ± FCM'e kaydet
      setupFCMForThisDevice(__me.uid);
      listenThreads();
    });
  }
  (document.readyState==='loading'? document.addEventListener('DOMContentLoaded',boot) : boot());
  </script>
</body>
</html>
